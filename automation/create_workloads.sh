#!/usr/bin/env bash

set -ex

CMD=oc

LABEL_EXP="/^  namespace: ns.*$/a\  labels:\n    vm.kubevirt.io/template: some-template"

# create 100 VMs
for ns in {001..005}; do
  sed "s#__NS__#${ns}#g" automation/ns.yaml | ${CMD} apply -f -
  for vm in {001..020}; do
    EXP=
    n=$(echo $vm | sed "s|^0*||")
    if [[ $(($n%2)) -eq 0 ]]; then
      EXP="; ${LABEL_EXP}"
    fi

    RUNNING=
    if [[ $n == '1' ]]; then
      RUNNING='; s|^(  runStrategy: )Halted$|\1Always|g'
    fi
    sed -E "s#__NS__#${ns}#g; s|##VM##|${vm}|g${EXP}${RUNNING}" automation/vm.yaml | ${CMD} apply -f -

  done
done

# wait for the execution of the first 5 VMs
for ns in {001..005}; do
  found=false
  for tries in {1..5}; do
    if ${CMD} get -n "ns${ns}" vmi "testvm-ns${ns}-vm001"; then
      found=true
      break
    else
      echo "vmi ns${ns}/testvm-ns${ns}-vm001 does not exist yet. waiting 10 second"
      sleep 10
    fi
  done

  if [[ $found != "true" ]]; then
    echo "vmi ns${ns}/testvm-ns${ns}-vm001 was not created"
    exit 1
  fi

  ${CMD} wait -n "ns${ns}" vmi "testvm-ns${ns}-vm001" --for condition=Ready --timeout=300s
done

${CMD} get vmis --all-namespaces
${CMD} get dvs --all-namespaces
